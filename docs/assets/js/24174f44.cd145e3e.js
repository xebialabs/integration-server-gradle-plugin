"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[678],{6617:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},assets:function(){return p},toc:function(){return u},default:function(){return h}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],s={title:"How to run a simple integration test",tags:["integration-test"]},l=void 0,c={permalink:"/integration-server-gradle-plugin/blog/2021/09/02/run-integration-test",source:"@site/blog/2021-09-02-run-integration-test.md",title:"How to run a simple integration test",description:"Requirements",date:"2021-09-02T00:00:00.000Z",formattedDate:"September 2, 2021",tags:[{label:"integration-test",permalink:"/integration-server-gradle-plugin/blog/tags/integration-test"}],readingTime:4.135,truncated:!1,authors:[]},p={authorsImageUrls:[]},u=[{value:"Requirements",id:"requirements",children:[]},{value:"Introduction",id:"introduction",children:[]},{value:"Test section explanation",id:"test-section-explanation",children:[]},{value:"Under the hood",id:"under-the-hood",children:[{value:"Downloading flow",id:"downloading-flow",children:[]},{value:"Test execution and troubleshooting",id:"test-execution-and-troubleshooting",children:[]}]}],d={toc:u};function h(e){var t=e.components,s=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h3",{id:"requirements"},"Requirements"),(0,o.kt)("p",null,"Documentation is applicable for a version ",(0,o.kt)("strong",{parentName:"p"},"10.3.0-902.1243")," or later."),(0,o.kt)("p",null,"The version of the plugin contains not random values, but you can read it next way\n10.3.0 means that it works for Deploy 10.3.0"),(0,o.kt)("p",null,"After minus the information of the time when it was released: ",(0,o.kt)("br",null),"\n902 - 2nd of September ",(0,o.kt)("br",null),"\n1020 - 10:20 AM ",(0,o.kt)("br",null)),(0,o.kt)("h3",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"I expect that you are the beginner of using this plugin, and your intention is to create your first integration test\nfor your custom plugin in against running Deploy instance. "),(0,o.kt)("p",null,"At this moment you can run only Jython based tests which are executed via CLI."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-groovy"},'integrationServer {\n    clis {\n        cli {\n            version = "10.3.0-902.1430"\n        }\n    }\n    servers {\n        controlPlane {\n            dockerImage = "xebialabs/xl-deploy"\n            version = "10.2.2"\n        }\n    }\n    tests {\n        testScenario01 {\n            baseDirectory = file("src/test/jython/scenarios")\n            extraClassPath = [file("src/test/jython/py-classpath")]\n            tearDownScripts = [\'teardown.py\']\n        }\n    }\n}\n')),(0,o.kt)("p",null,"In CLI section we specify the version which is available publicly. It can mismatch with Deploy server.\nMost of the time it is backward compatible. Specially for the usage of it inside of integration server CLI was changed,\ntherefore you can't use CLI with a lower version than ",(0,o.kt)("inlineCode",{parentName:"p"},"10.3.0-902.1430"),". "),(0,o.kt)("h3",{id:"test-section-explanation"},"Test section explanation"),(0,o.kt)("p",null,"In tests section, you can create multiple test sections. At this blog we will take a look at the simplest configuration required.\nFirst of all, you have to define where are your all tests resides, what is the base directory of it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-groovy"},'baseDirectory = file("src/test/jython/scenarios")\n')),(0,o.kt)("p",null,"This is exactly what we do here. Then you can create sub-folders and keep each scenario in own folder."),(0,o.kt)("p",null,"CLI is a java process which has own classpath and can contain inside the python modules so that you can have access to them from your tests.\nQuite useful to keep there the shared utils. For example, it can be assertion tools or variables (like in teardown script to know what to scrape out).\nFor that you can add extra folders to a default classpath strategy of CLI by"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-groovy"},'extraClassPath = [file("src/test/jython/py-classpath")]\n')),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Default strategy to compose a classpath for CLI can be found in ",(0,o.kt)("inlineCode",{parentName:"p"},"cli.(sh|cmd)")," script. Namely, these lines (for *.sh):"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},"for each in `ls hotfix/*.jar lib/*.jar plugins/*.jar 2>/dev/null`\ndo\n  if [ -f $each ]; then\n    DEPLOYIT_CLI_CLASSPATH=${DEPLOYIT_CLI_CLASSPATH}:${each}\n  fi\ndone\n")),(0,o.kt)("p",{parentName:"div"},"So it means that you can also leverage from creating your own python module, archive it as ",(0,o.kt)("inlineCode",{parentName:"p"},"jar")," and use ",(0,o.kt)("inlineCode",{parentName:"p"},"overlays")," to\nplace it in CLI as a ",(0,o.kt)("inlineCode",{parentName:"p"},"plugin")," or a ",(0,o.kt)("inlineCode",{parentName:"p"},"lib"),". You can take it as an alternative whenever you have to reuse same logic across\nmultiple repositories. "))),(0,o.kt)("p",null,"When test has finished, successfully or not, it is a good practice to clean up everything what test created.\nThis configuration is exactly for this purpose:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-groovy"},"tearDownScripts = ['teardown.py']\n")),(0,o.kt)("p",null,"Full set of options for this section you can find here:\n",(0,o.kt)("a",{parentName:"p",href:"https://xebialabs.github.io/integration-server-gradle-plugin/docs/getting-started/configuration#tests-section"},"https://xebialabs.github.io/integration-server-gradle-plugin/docs/getting-started/configuration#tests-section")," "),(0,o.kt)("p",null,"For a full version of this configuration file (and the project), have look at an example:\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/acierto/xld-simple-itest"},"https://github.com/acierto/xld-simple-itest")),(0,o.kt)("h2",{id:"under-the-hood"},"Under the hood"),(0,o.kt)("p",null,"Great, we set it up. Let's figure out how it works."),(0,o.kt)("h3",{id:"downloading-flow"},"Downloading flow"),(0,o.kt)("p",null,"We download a server and CLI to a build folder. As you can see it on the picture: "),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"cli-and-server",src:n(5803).Z})),(0,o.kt)("p",null,"As we didn't apply any modification sections as ",(0,o.kt)("inlineCode",{parentName:"p"},"overlays"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"copyBuildArtifacts"),", etc. the structure and content there\nwould be same as from Nexus/Docker image."),(0,o.kt)("h3",{id:"test-execution-and-troubleshooting"},"Test execution and troubleshooting"),(0,o.kt)("p",null,"Test runner is looking at the configurations, searching for a base folder to scan there files and then creates a sequence of them to execute.\nAs we have only 1 test and 1 teardown script we will see as a source for CLI 2 tests. I'll refer to the available logs produced\nby GitHub Actions ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/acierto/xld-simple-itest/runs/3495662609"},"https://github.com/acierto/xld-simple-itest/runs/3495662609"),"."),(0,o.kt)("p",null,"There we can find the next log snippet: ",(0,o.kt)("img",{alt:"Log snippet",src:n(524).Z})),(0,o.kt)("p",null,"What is interesting to see here for us: ",(0,o.kt)("br",null)),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"To pay attention to that we connect to a non-default port ",(0,o.kt)("inlineCode",{parentName:"p"},"-port 43735"),". In a server section we didn't specify\nthe fixed port, so we are running it on a random. It's very important if you want to run several tests in parallel and to not clash\nby using the same port. CLI picks that information by reading in the file ",(0,o.kt)("inlineCode",{parentName:"p"},"conf/deployit.conf")," a property value for a key ",(0,o.kt)("inlineCode",{parentName:"p"},"http.port"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"As we didn't define a socket port, it is running with a timeout of 1 minute: ",(0,o.kt)("inlineCode",{parentName:"p"},"-socketTimeout 60000"),". If you'll have some long-running scripts which\nwill take longer than that, this is a place to tune it. ")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"As order of Python test execution matters, you can check it out in an option ",(0,o.kt)("inlineCode",{parentName:"p"},"-source"),". In this example we can see the next:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},"-source /home/runner/work/xld-simple-itest/xld-simple-itest/src/test/jython/scenarios/create-ci.py,/home/runner/work/xld-simple-itest/xld-simple-itest/src/test/jython/scenarios/teardown.py\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"All the logs related to a CLI execution will be saved in ",(0,o.kt)("inlineCode",{parentName:"li"},"<CLI_HOME>/log")," and exact location for this log is also specified, for a convenience of troubleshooting:\n",(0,o.kt)("inlineCode",{parentName:"li"},"/home/runner/work/xld-simple-itest/xld-simple-itest/build/integration-server/xl-deploy-10.3.0-902.941-cli/log/test-0e873cfc.log"),".\nAfter each re-run we remove old logs to not be buried under multiple versions of it. Be aware to copy it to another location if you'd like to preserve it.")))}h.isMDXComponent=!0},5803:function(e,t,n){t.Z=n.p+"assets/images/downloading-server-and-cli-8c017b86ea6b473707999f2871e1fd27.png"},524:function(e,t,n){t.Z=n.p+"assets/images/gradle-logs-related-to-running-cli-0931bf82a311a08948d7a614bdfd9ad8.png"}}]);